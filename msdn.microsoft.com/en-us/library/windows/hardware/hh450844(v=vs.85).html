<!DOCTYPE html>

<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml" lang="en">
    
<!-- Mirrored from msdn.microsoft.com/en-us/library/windows/hardware/hh450844(v=vs.85).aspx by HTTrack Website Copier/3.x [XR&CO'2013], Mon, 17 Mar 2014 17:15:58 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><link rel="canonical" href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh450844(v=vs.85).aspx" />
        <title>Allocating and Building URBs (Windows Drivers)</title>




<meta name="DCS.dcsuri" content="/en-us/library/windows/hardware/hh450844(d=default,l=en-us,v=vs.85).aspx" />

<meta name="NormalizedUrl" content="http://msdn.microsoft.com/en-us/library/windows/hardware/hh450844(d=default,l=en-us,v=vs.85).aspx" />

<meta name="ms.normalizedurl" content="http://msdn.microsoft.com/en-us/library/windows/hardware/hh450844(d=default,l=en-us,v=vs.85).aspx" />

<meta name="VotingContextUrl" content="http://msdn.microsoft.com/en-us/library/windows/hardware/hh450844(d=default,l=en-us,v=vs.85).aspx" />

<meta name="MN" content="61C41DCF-9:30:32 AM" />

<meta name="Search.ShortId" content="hh450844" />

<meta name="ms.shortidmsdn" content="hh450844" />

<meta name="Ms.Locale" content="en-us" />







        
    <link rel="shortcut icon" href="http://msdn.microsoft.com/Areas/Epx/Themes/Windows/Content/Winlogo_favicon.ico" />

    <link rel="stylesheet" type="text/css" href="http://i3.msdn.microsoft.com/Combined.css?resources=0:Topic,0:CodeSnippet,0:ExpandableCollapsibleArea,1:CommunityContent,0:TopicNotInScope,0:FeedViewerBasic,0:ImageSprite,2:Header,2:sprite,1:Toc,1:LibraryMemberFilter,2:Footer,3:DetailedLinkList,3:LinkList,4:Windows;/Areas/Epx/Content/Css:0,/Areas/Library/Content:1,/Areas/Epx/Themes/Windows/Content:2,/Areas/Epx/Themes/Base/Content:3,/Areas/Library/Themes/Windows/Content:4&amp;amp;hashKey=E1AF301680B6D838738C2F52E9149624" /></head>
    <body class="library ">
        <div id="page">
            
            
  
            
    
    

    <div id="ux-header" class=" ltr">
        <div id="headerContainer">
            <div id="logoAndSearchBox">
                <div id="logo">
                    <a href="http://msdn.microsoft.com/windows/" title="Windows"><img alt="Windows" src="http://i.msdn.microsoft.com/Areas/Epx/Themes/Windows/Content/Windows_logo.png"></img></a>       
                </div>
              
        <div id="selectedTab">
            <a class="dropDownToggle" href="javascript:void(0);">Dev Center - Hardware</a>    
        </div>
    <div id="toclevel1_menu" style="display: none;">
        <ul>
                <li><a href="http://msdn.microsoft.com/windows/" title="Dev Center Home">Dev Center Home</a></li>
                <li><a href="http://msdn.microsoft.com/windows/apps/" title="Windows Store apps">Windows Store apps</a></li>
                <li><a href="http://msdn.microsoft.com/ie/" title="Internet Explorer">Internet Explorer</a></li>
                <li><a href="http://msdn.microsoft.com/windows/desktop/" title="Desktop">Desktop</a></li>
                <li><a href="http://msdn.microsoft.com/windows/hardware/" title="Hardware">Hardware</a></li>
        </ul>
        <div style="clear: both"></div>
    </div> 

                
                  

        <div class="SearchBox">   
            <form id="HeaderSearchForm" name="HeaderSearchForm" method="get" onsubmit="return Epx.Controls.SearchBox.searchBoxOnSubmit(this);">
            <input id="HeaderSearchTextBox" name="query" type="text" maxlength="200" onfocus="Epx.Controls.SearchBox.watermarkFocus(event, this.title)" onblur="Epx.Controls.SearchBox.watermarkBlur(event, this.title)" />            
            <button id="HeaderSearchButton" value="" type="submit" class="header-search-button"></button>
            </form>
         
                
                 
    
        </div>

                <div class="Clear"></div>
            </div>
            <div class="Clear"></div>
            <div class="ux-internav">
    <div class="toclevel2"> 
            <a class="normal" href="https://sysdev.microsoft.com/en-us/hardware/" title="Dashboard">Dashboard</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg507680" title="Get Started ">Get Started </a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg462970" title="Design">Design</a>
            <a class="active" href="http://msdn.microsoft.com/windows/hardware/ff960953" title="Develop">Develop</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg463010" title="Certify">Certify</a>
    </div>
    <div class="clear"></div>

            </div>
            <div id="signIn">

<a class="scarabLink" href="https://login.live.com/login.srf?wa=wsignin1.0&amp;rpsnv=12&amp;ct=1395073832&amp;rver=6.0.5276.0&amp;wp=MCLBI&amp;wlcxt=MSDN%24MSDN%24MSDN&amp;wreply=http%3a%2f%2fmsdn.microsoft.com%2fen-us%2flibrary%2fwindows%2fhardware%2fhh450844%2528v%3dvs.85%2529.aspx&amp;lc=1033&amp;id=254354&amp;mkt=en-US" title="Sign in">Sign in</a></div>

    

        </div>  
        <div id="blackBar">
    <div class="toclevel3"> 
            <a class="normal" href="http://msdn.microsoft.com/library/windows/hardware/gg454504" title="Systems">Systems</a>
            <a class="normal" href="http://msdn.microsoft.com/library/windows/hardware/gg454505" title="Devices">Devices</a>
            <a class="active" href="http://msdn.microsoft.com/library/windows/hardware/ff557573" title="Drivers">Drivers</a>
            <a class="normal" href="http://msdn.microsoft.com/library/windows/hardware/ff551063(v=vs.85).aspx" title="Debugging">Debugging</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg454513" title="Downloads">Downloads</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/dn433227.aspx" title="Samples">Samples</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg454517" title="Community">Community</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/dn550976" title="Archives">Archives</a>
    </div>
    <div class="clear"></div>

        </div>
    </div>


        
            <div id="body">
                







    <div id="leftNav">



<div id="tocnav">
            <div class="toclevel0" data-toclevel="0">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff557557(v=vs.85).aspx" id="ff576019_VS.85_en-us" mtpsaliasid="" mtpsassetid="1ef3e216-1322-42c3-b070-94cddfb2133c_VS.85_en-us" mtpsshortid="ff557557_VS.85_en-us" title="Device and Driver Technologies">Device and Driver Technologies</a>            </div>
            <div class="toclevel0" data-toclevel="0">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff557547(v=vs.85).aspx" id="hh440424_VS.85_en-us" mtpsaliasid="" mtpsassetid="5cefa114-cec1-4058-a7a9-08e0b13fe412_VS.85_en-us" mtpsshortid="ff557547_VS.85_en-us" title="Bus and Port Drivers">Bus and Port Drivers</a>            </div>
            <div class="toclevel0" data-toclevel="0">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538930(v=vs.85).aspx" id="dn303474_VS.85_en-us" mtpsaliasid="" mtpsassetid="45ba2638-b1b9-409d-bd23-78e75a3515be_VS.85_en-us" mtpsshortid="ff538930_VS.85_en-us" title="Universal Serial Bus (USB)">Universal Serial Bus (USB)</a>            </div>
            <div class="toclevel0" data-toclevel="0">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406260(v=vs.85).aspx" id="hh948131_VS.85_en-us" mtpsaliasid="" mtpsassetid="CA11CE23-B0BA-4932-A2BE-983F070B51D6_VS.85_en-us" mtpsshortid="hh406260_VS.85_en-us" title="Developing Windows client drivers for USB devices">Developing Windows client drivers for USB devices</a>            </div>
            <div class="toclevel1" data-toclevel="1">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff537056(v=vs.85).aspx" id="hh948136_VS.85_en-us" mtpsaliasid="" mtpsassetid="15be1e51-5ab2-40c4-95a8-8555c92523aa_VS.85_en-us" mtpsshortid="ff537056_VS.85_en-us" title="About USB Block Requests (URBs)">About USB Block Requests (URBs)</a>            </div>
            <div class="toclevel2 current" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh450844(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="Allocating and Building URBs">Allocating and Building URBs</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh450899(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="How to Submit an URB">How to Submit an URB</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406258(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="Best Practices: Using URBs">Best Practices: Using URBs</a>            </div>
</div>
        

        

        
        
        <div id="toc-resizable-ew" class="toc-resizable-ew"></div>
        
    </div>
<div id="content" class="content">







        

<div class="topic" xmlns="http://www.w3.org/1999/xhtml">
  <h1 class="title">Allocating and Building URBs</h1>
  
  <div id="mainSection">
<div class="clsServerSDKContent">

</div>
<p> This topic describes how a USB client driver can use Windows Driver Model (WDM) driver routines to allocate and format an  URB before sending the request to the Microsoft-provided USB driver stack.</p>
<p>The client driver uses an URB to package all information required by the lower drivers in the USB driver stack to process the request. In the Windows operating system, an URB is described in a <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure. </p>
<p>Microsoft provides a library of <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff540046(v=vs.85).aspx#client">Routines for USB Client Drivers</a>. By using those routines, USB client drivers can build URB requests for certain specified operations and forward them down the USB stack. If you prefer, you can design your client driver to call the library routines for the supported operations rather than building your own URB requests. </p>
<p>This topic contains the following sections:</p>
<p>
</p><ul>
<li><a href="#urb_allocation_in_windows_7_and_earlier">URB Allocation in Windows 7 and Earlier</a></li>
<li><a href="#urb_allocation_in_windows_8">URB Allocation in Windows 8</a></li>
<li><a href="#urb_routine_migration">URB Routine Migration</a></li>
<li><a href="#related_topics">Related topics</a></li>
</ul>

<h2><a id="URB_Allocation_in_Windows_7_and_Earlier"></a><a id="urb_allocation_in_windows_7_and_earlier"></a><a id="URB_ALLOCATION_IN_WINDOWS_7_AND_EARLIER"></a>URB Allocation in Windows 7 and Earlier</h2>
<p>To send a USB request by using routines included in Windows Driver Kit (WDK) for Windows 7 and earlier versions of Windows, a client driver typically allocates and fills a <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure, associates the <strong>URB</strong> structure with a new IRP, and sends the IRP to the USB driver stack.
</p>
<p>For certain types of requests, Microsoft provides helper routines (exported by Usbd.sys)  that allocate and format the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure. For example, the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff539029(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_CreateConfigurationRequestEx</strong></a> routine allocates memory for an <strong>URB</strong> structure, formats the URB for a select-configuration request, and returns the address of the <strong>URB</strong> structure to the client driver.
However, the helper routines cannot be used for all types of requests.</p>
<p>Microsoft also provides macros that format URBs for some types of requests. For those macros, the client driver must allocate the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff544520(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">ExAllocatePoolWithTag</strong></a> or allocate the structure on the stack. For example, after the client driver allocates an <strong>URB</strong>, the driver can call <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538968(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">UsbBuildSelectConfigurationRequest</strong></a> to format the URB for a select-configuration request or to clear the configuration.</p>
<p>For other requests the client driver must allocate and format the URB manually by setting various members of the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure, depending on the request type.</p>
<p>When a USB request is complete, the client driver must release the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure. If the URB is allocated on the stack, the URB is released when it goes out of scope. If the URB is allocated in nonpaged pool, the client driver must call <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff544590(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">ExFreePool</strong></a> to release the URB.
</p>
<h2><a id="URB_Allocation_in_Windows_8"></a><a id="urb_allocation_in_windows_8"></a><a id="URB_ALLOCATION_IN_WINDOWS_8"></a>URB Allocation in Windows 8</h2>
<p>WDK for Windows 8 provides a new static library,  Usbdex.lib, that exports routines for allocating, formatting, and releasing URBs. In addition, there is a new way of associating an URB with an IRP. The new routines can be called by a client driver targeting Windows Vista and later versions of Windows. </p>
<p>A client driver running on Windows Vista and later must use the new routines so that the underlying USB driver stack can utilize certain performance and reliability improvements. Those improvements apply to the new USB driver stack introduced in Windows 8 to support USB 3.0 devices and host controllers. For USB 2.0 host controllers, Windows loads an earlier version of the driver stack that does not support the improvements. Regardless of the version of the underlying driver stack or the protocol version supported by the host controller, you must always call the new URB routines.</p>
<p>Before you call any of the new routines, make sure that you have a USBD handle for your client driver registration with the USB driver stack. To obtain a USBD handle, call <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406241(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_CreateHandle</strong></a>. </p>
<p> The following routines are available with the WDK for Windows 8. These routines are defined in Usbdlib.h.</p>
<p>
</p><ul>
<li>
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406250(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_UrbAllocate</strong></a>
</li>
<li>
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406231(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_IsochUrbAllocate</strong></a>
</li>
<li>
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406243(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_SelectConfigUrbAllocateAndBuild</strong></a>
</li>
<li>
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406245(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_SelectInterfaceUrbAllocateAndBuild</strong></a>
</li>
<li>
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406252(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_UrbFree</strong></a>
</li>
<li>
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406228(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_AssignUrbToIoStackLocation</strong></a>
</li>
</ul> 

 The allocation routines in the preceding list return a pointer to a new <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure, which is allocated by the USB driver stack. Depending on the version of the USB driver stack loaded by Windows, the <strong>URB</strong> structure can be paired with an opaque <em>URB context</em>. An URB context is a block of information  about the URB. You cannot view the contents of the URB header; the information is intended to be used internally by the USB driver stack to improve URB tracking and processing. The URB context is <em>only</em> used by the USB driver stack for Windows 8. 
<p>If URB context is available, the USB driver stack uses it to make URB processing safer and more efficient. For example, the USB driver stack must make sure that the client driver does not submit an URB and then attempt to reuse that same URB before the first request has completed. To detect that kind of error, the USB driver stack stores state information in the URB context. Without the state information, the USB driver stack would have to compare the incoming URB with all URBs currently in progress. The state information is also used by the USB driver stack when the client driver attempts to release the URB.  Before releasing the URB, the USB driver stack verifies  the state to make sure that the URB is not pending.</p>
<p>URB context provides an official mechanism for storing extra URB information. Using URB context is preferable to allocating extra memory as needed or storing extra information in reserved members of the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure. The USB driver stack allocates URBs and their associated URB context in nonpaged pool, so that in the future if larger URB context are needed, the only required adjustment will be the size of a pool allocation.</p>
<h2><a id="URB_Routine_Migration"></a><a id="urb_routine_migration"></a><a id="URB_ROUTINE_MIGRATION"></a>URB Routine Migration</h2>
<p>The following table summarizes the changes in URB routines.</p>
<table>
<tr><th>Use case</th><th>Available in WDK for Windows 7 and earlier</th><th>Available in WDK for Windows 8</th></tr>
<tr><th></th><th>Targets Windows 7 and earlier versions of the operating system</th><th>Targets Windows Vista and later versions of the operating system</th></tr>
<tr><td>To create an URB...</td><td>The client driver allocates a <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure and formats the structure depending on the request. <p>The client driver allocates the URB structure on the stack, or the  driver allocates the structure in nonpaged pool by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff544520(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">ExAllocatePoolWithTag</strong></a>. </p>
</td><td>The client driver calls <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406250(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_UrbAllocate</strong></a> and receives a pointer to the new <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure, which is allocated by the USB driver stack. The URB might be associated with an URB context, depending on the USBD interface version of the underlying USB driver stack.</td></tr>
<tr><td>To create an URB for a select-configuration request...</td><td>The client driver calls the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff539029(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_CreateConfigurationRequestEx</strong></a> routine that returns a pointer to the new URB that is created and formatted by the USB driver stack.</td><td>The client driver calls <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406243(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_SelectConfigUrbAllocateAndBuild</strong></a> and receives a pointer to the new <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure, which is allocated and formatted (for the select-configuration request) by the USB driver stack. The URB might be associated with an URB context, depending on the USBD interface version of the underlying USB driver stack.</td></tr>
<tr><td>To create a URB for an select-interface request...</td><td>The client driver allocates a <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure and uses the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff540425(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">_URB_SELECT_INTERFACE</strong></a> structure to define the format of a select interface command for a USB device.</td><td>The client driver calls <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406245(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_SelectInterfaceUrbAllocateAndBuild</strong></a> and receives a pointer to the new <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure, which is allocated and formatted (for the select-interface request) by the USB driver stack. The URB might be associated with an URB context, depending on the USBD interface version of the underlying USB driver stack.</td></tr>
<tr><td>To associate an URB with an IRP...</td><td>The client driver gets a pointer to the next IRP stack location by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff549266(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">IoGetNextIrpStackLocation</strong></a>. Then the client driver manually sets the 
<strong>Parameters.Others.Argument1</strong> member of the stack location to the address of the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538923(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">URB</strong></a> structure.
 
</td><td>The client driver gets a pointer to the next IRP stack location by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff549266(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">IoGetNextIrpStackLocation</strong></a>. Then the client driver calls <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406228(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_AssignUrbToIoStackLocation</strong></a> to associate a the URB with the stack location.</td></tr>
<tr><td>To release an URB...</td><td>If the client driver allocates a URB on the stack, the variable goes out of scope after the request is complete.<p>To free a URB structure that the client driver or the USB driver stack allocated in nonpaged pool, the client driver calls <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff544590(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">ExFreePool</strong></a>.</p>
</td><td>The client driver calls <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406252(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">USBD_UrbFree</strong></a>.</td></tr>
</table>
<p> </p>
<h2><a id="related_topics"></a>Related topics</h2>
<dl>
<dt>
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff537056(v=vs.85).aspx">Sending Requests to a USB Device</a>
</dt>
</dl>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [usbcon\buses]:%20Allocating and Building URBs%20 RELEASE:%20(2/20/2014)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
</div>

    




<div class="libraryMemberFilter">
    <div class="filterContainer">
        <span>Show:</span>
        <label>
            <input type="checkbox" class="libraryFilterInherited" checked="checked" value="Inherit" />Inherited
        </label>
        <label>
            <input type="checkbox" class="libraryFilterProtected" checked="checked" value="Protected" />Protected
        </label>
    </div>
</div>
    
<input type="hidden" id="libraryMemberFilterEmptyWarning" value="There are no members available with your current filter settings." />


 
</div>




            </div>
            <div class="clear"></div>
        
            
    
<input name="__RequestVerificationToken" type="hidden" value="odTnjFjyAd1ZMTnQsOIyNt22yY4AjI0D26Rqq3GPsbDIJRkD2RpXg4vMJBmw6fALlgCxYqW0ZmJAJ9bFLkgZVwtKCpAhPbTAl9fvH0xdk-IfWnIsDrzCGpmK-2Geiag4IP6otw2" />
<input id="ratingSubmitUrl" type="hidden" value="http://msdn.microsoft.com/en-us/library/feedback/add/hh450844(v=vs.85).aspx" />
<input id="isTopicRated" type="hidden" value="false" />




    


    <div id="ux-footer" class=" ltr">
        
            <div id="footerSock">
                <div id="footerSockInner">
                    <a name="feedback"></a>
                    <div data-fragmentName="Survey" id="Fragment_Survey" xmlns="http://www.w3.org/1999/xhtml">
  <div class="DetailedLink">
    
    <div class="Content"></div>
  </div>
</div>
<div class="rating">
    <div id="ratingSection1">
        <div class="title">
            Was this page helpful?
        </div>
        <div class="description">
            Your feedback about this content is important.<br />Let us know what you think.
        </div>
        <div class="buttons">
            <button id="ratingYes">Yes</button>
            <button id="ratingNo">No</button>
        </div>
        <input id="ratingValue" type="hidden" value="" />
    </div>
    <div id="ratingSection2">
        <div class="title">
            Additional feedback?
        </div>
        <textarea id="ratingText" rows="6" cols=""></textarea>
        <div class="buttons">
            <button id="ratingSubmit">Submit</button>
            <button id="ratingSkipThis">Skip this</button>
        </div>
    </div>
    <div id="ratingSection3">
        <div class="title">
            Thank you!
        </div>
        <div class="description">
            We appreciate your feedback.
        </div>
    </div>
    
    
    <div id="contentFeedbackQAContainer" style="display: none;"></div>
</div>


                    <div data-fragmentName="SockLinks" id="Fragment_SockLinks" xmlns="http://www.w3.org/1999/xhtml">
  
  <div class="LinkList">
    <div class="Links">
      <ul class="LinkColumn" style="width: 100%">
        <li>
          <a href="http://go.microsoft.com/fwlink/p/?LinkId=317805" id="SockLinks_727_11" xmlns="http://www.w3.org/1999/xhtml">Find us on Facebook</a>
        </li>
        <li>
          <a href="http://go.microsoft.com/fwlink/p/?LinkId=317806" id="SockLinks_727_12" xmlns="http://www.w3.org/1999/xhtml">Follow us on Twitter</a>
        </li>
        <li>
          <a href="http://go.microsoft.com/fwlink/p/?linkid=285656" id="SockLinks_727_40" xmlns="http://www.w3.org/1999/xhtml">Read the hardware blog</a>
        </li>
      </ul>
    </div>
  </div>
</div>
                    <div class="clear"></div>
                </div>
            </div>
        <div id="footerContainer">
            <div id="fourColumnFooter">
                <div data-fragmentName="Column1" id="Fragment_Column1" xmlns="http://www.w3.org/1999/xhtml">
  <div class="ListOfLinkLists">
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Centers</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://msdn.microsoft.com/windows" id="Column1_727_13" xmlns="http://www.w3.org/1999/xhtml">Dev Center Home</a>
          </li>
          <li>
            <a href="http://msdn.microsoft.com/windows/apps" id="Column1_727_14" xmlns="http://www.w3.org/1999/xhtml">Windows Store apps</a>
          </li>
          <li>
            <a href="http://msdn.microsoft.com/ie" id="Column1_727_15" xmlns="http://www.w3.org/1999/xhtml">Internet Explorer</a>
          </li>
          <li>
            <a href="http://msdn.microsoft.com/windows/desktop" id="Column1_727_16" xmlns="http://www.w3.org/1999/xhtml">Desktop</a>
          </li>
          <li>
            <a href="http://msdn.microsoft.com/windows/hardware" id="Column1_727_17" xmlns="http://www.w3.org/1999/xhtml">Hardware</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>              
                <div data-fragmentName="Column2" id="Fragment_Column2" xmlns="http://www.w3.org/1999/xhtml">
  <div class="ListOfLinkLists">
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Related developer sites</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285634" id="Column2_727_18" xmlns="http://www.w3.org/1999/xhtml">Microsoft Connect</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285635" id="Column2_727_19" xmlns="http://www.w3.org/1999/xhtml">OSR Online</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=282089" id="Column2_727_42" xmlns="http://www.w3.org/1999/xhtml">Visual Studio</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=280293" id="Column2_727_20" xmlns="http://www.w3.org/1999/xhtml">Windows Phone</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=282087" id="Column2_727_43" xmlns="http://www.w3.org/1999/xhtml">Windows Server</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Other Windows sites</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285636" id="Column2_727_21" xmlns="http://www.w3.org/1999/xhtml">Enterprise</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285637" id="Column2_727_22" xmlns="http://www.w3.org/1999/xhtml">Small business</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285638" id="Column2_727_23" xmlns="http://www.w3.org/1999/xhtml">Students</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285639" id="Column2_727_24" xmlns="http://www.w3.org/1999/xhtml">Home users</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>              
                <div data-fragmentName="Column3" id="Fragment_Column3" xmlns="http://www.w3.org/1999/xhtml">
  <div class="ListOfLinkLists">
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Downloads</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285645" id="Column3_727_25" xmlns="http://www.w3.org/1999/xhtml">Windows Driver Kit</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285646" id="Column3_727_26" xmlns="http://www.w3.org/1999/xhtml">Windows Assessment and Deployment Kit</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285647" id="Column3_727_27" xmlns="http://www.w3.org/1999/xhtml">Windows Hardware Certification Kit</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?LinkID=316548" id="Column3_727_29" xmlns="http://www.w3.org/1999/xhtml">Visual Studio Professional 2013</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285649" id="Column3_727_30" xmlns="http://www.w3.org/1999/xhtml">More downloads</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Support</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285664" id="Column3_727_44" xmlns="http://www.w3.org/1999/xhtml">Forums</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285663" id="Column3_727_45" xmlns="http://www.w3.org/1999/xhtml">More support options</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>              
                <div data-fragmentName="Column4" id="Fragment_Column4" xmlns="http://www.w3.org/1999/xhtml">
  <div class="ListOfLinkLists">
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Essentials</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285650" id="Column4_727_46" xmlns="http://www.w3.org/1999/xhtml">Recently published</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285651" id="Column4_727_47" xmlns="http://www.w3.org/1999/xhtml">Debugging</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=328186" id="Column4_727_48" xmlns="http://www.w3.org/1999/xhtml">Samples</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285653" id="Column4_727_49" xmlns="http://www.w3.org/1999/xhtml">Hardware dashboard</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=317804" id="Column4_727_50" xmlns="http://www.w3.org/1999/xhtml">Partner with Microsoft</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Stay connected</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285658" id="Column4_727_36" xmlns="http://www.w3.org/1999/xhtml">Microsoft events</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=313299" id="Column4_727_37" xmlns="http://www.w3.org/1999/xhtml">Windows App Builder Blog</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>              
            </div>

            <div id="baseFooterLogos">
                <span class="microsoftlogo" title="Microsoft"></span>
                <a href="http://msdn.microsoft.com/en-us" class="msdnlogo" title="MSDN"></a>
            </div>
        
            <div id="baseFooter">
                <div id="FooterCopyright">© 2014 Microsoft</div>
                <div data-fragmentName="BaseFooterContent" id="Fragment_BaseFooterContent" xmlns="http://www.w3.org/1999/xhtml">
  <div xmlns="http://www.w3.org/1999/xhtml">
    <div xmlns:mtps="http://msdn2.microsoft.com/mtps">
      <div data-fragmentName="BaseFooter" id="Fragment_BaseFooter">
        
        <div class="LinkList">
          <div class="Links">
            <ul class="LinkColumn horizontal">
              <li>
                <a href="http://msdn.microsoft.com/windows/apps/cc300389" id="BaseFooter_35351_1" xmlns="http://www.w3.org/1999/xhtml">Terms of Use</a>
              </li>
              <li>
                <a href="http://www.microsoft.com/library/toolbar/3.0/trademarks/en-us.mspx" id="BaseFooter_35351_2" xmlns="http://www.w3.org/1999/xhtml">Trademarks</a>
              </li>
              <li>
                <a href="http://www.microsoft.com/info/privacy.mspx" id="BaseFooter_35351_3" xmlns="http://www.w3.org/1999/xhtml">Privacy and Cookies</a>
              </li>
              <li>
                <a href="http://msdn.microsoft.com/en-us/windows/dn554289" id="BaseFooter_730_5" xmlns="http://www.w3.org/1999/xhtml">Site map</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div data-fragmentName="HelloText" id="Fragment_HelloText">Hello from Seattle.
</div>
    </div>
  </div>
</div>  
                    <form class="selectLocale" id="selectLocaleForm" action="http://msdn.microsoft.com/en-us/windows/hardware/SelectLocale">
        <input type="hidden" name="fromPage" value="http%3a%2f%2fmsdn.microsoft.com%2fen-us%2flibrary%2fwindows%2fhardware%2fhh450844(v%3dvs.85).aspx" />
        <a href="#" onclick="$('#selectLocaleForm').submit();return false;" title="Change your language">United States (English)</a>
    </form>    


                <div class="clear"></div>
            </div>
        </div>
    </div> 


            <div class="footerPrintView">
                <div class="footerCopyrightPrintView">© 2014 Microsoft. All rights reserved.</div>
            </div>

            
            
    


        
            <input id="MtpsDevice" type="hidden" value="Default" />


<![CDATA[ Third party scripts and code linked to or referenced from this website are licensed to you by the parties that own such code, not by Microsoft.  See ASP.NET Ajax CDN Terms of Use – http://www.asp.net/ajaxlibrary/CDN.ashx. ]]>
        
            
            
            
            
            
        





<noscript><div><img alt="DCSIMG" id="Img1" width="1" height="1" src="http://m.webtrends.com/dcsmgru7m99k7mqmgrhudo0k8_8c6m/njs.gif?dcsuri=/nojavascript&amp;WT.js=No" /></div></noscript>









<noscript>
  <a href="http://www.omniture.com/" title="Web Analytics">
    <img src="http://msstonojsmsdn.112.2o7.net/b/ss/msstonojsmsdn/1/H.20.2--NS/0" height="1" width="1" border="0" alt="" />
  </a>
</noscript>




<div id="globalRequestVerification">
    <input name="__RequestVerificationToken" type="hidden" value="zfvnWU4mEJpAGdZXStsB7pyNGcm5u9_E6vX1cBhttH9uT89J72bjs6siusAlwKf_OzEEGmor94vKH6cDn50g7QSlQl5VeOM1mo4qNXRBKCD-ExdUKaWHdoUzC9nRqvufYdg2QQ2" />
</div>


        </div>
    <script type="text/javascript" class="mtps-injected">
/*<![CDATA[*/
(function(window,document){"use strict";function preload(scripts){for(var result=[],script,e,i=0;i<scripts.length;i++)script=scripts[i],script.hasOwnProperty("url")&&(e=document.createElement("script"),e.src=script.url,script.throwaway=e),result.push(script);return result}function inject(scripts,index){var script,elem;if(index>=scripts.length){delete mtps.injectScripts;return}script=scripts[index];elem=document.createElement("script");elem.className="mtps-injected";elem.async=!1;var isLoaded=!1,timeoutId=0,injectNextFnName="",injectNext=elem.onerror=function(){isLoaded||(isLoaded=!0,inject(scripts,index+1),window.clearTimeout(timeoutId),elem.onload=elem.onerror=elem.onreadystatechange=null,injectNextFnName&&delete mtps[injectNextFnName],elem.removeEventListener&&elem.removeEventListener("load",injectNext,!1))};elem.addEventListener?elem.addEventListener("load",injectNext,!1):elem.readyState==="uninitialized"?elem.onreadystatechange=function(){(this.readyState==="loaded"||this.readyState==="complete")&&injectNext()}:elem.onload=injectNext;script.hasOwnProperty("url")?(timeoutId=window.setTimeout(injectNext,12e4),elem.src=script.url):(injectNextFnName="_injectNextScript_"+index,mtps[injectNextFnName]=injectNext,timeoutId=window.setTimeout(injectNext,2e3),elem.text="try {\n"+script.txt+"\n} finally { MTPS."+injectNextFnName+" && MTPS."+injectNextFnName+"(); }");parent.appendChild(elem)}var mtps=window.MTPS||(window.MTPS={}),parent=document.getElementsByTagName("head")[0];mtps.injectScripts=function(scripts){inject(preload(scripts),0)}})(window,document);
MTPS.injectScripts([
	{ txt: "/**/\r\n(window.MTPS || (window.MTPS = {})).cdnDomains || (window.MTPS.cdnDomains = { \r\n\t\"image\": \"http://i.msdn.microsoft.com\", \r\n\t\"js\": \"http://i2.msdn.microsoft.com\", \r\n\t\"css\": \"http://i3.msdn.microsoft.com\"\r\n});\r\n/**/" },
	{ url: "http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.2.min.js" },
	{ txt: "//\n  var literalNormalizedUrl = \u0027/en-us/library/windows/hardware/hh450844(d=default,l=en-us,v=vs.85).aspx\u0027;\n  var wt_nvr_ru = \u0027WT_NVR_RU\u0027;\n  var wt_fpcdom = \u0027.microsoft.com\u0027;\n  var wt_domlist = \u0027msdn.microsoft.com\u0027;\n  var wt_pathlist = \u0027\u0027;\n  var wt_paramlist = \u0027DCSext.mtps_devcenter\u0027;\n  var wt_siteid = \u0027MSDN\u0027;\n  var gDomain = \u0027m.webtrends.com\u0027;\n  var gDcsId = \u0027dcsmgru7m99k7mqmgrhudo0k8_8c6m\u0027;\n  var gFpc = \u0027WT_FPC\u0027;\n\n\n\n  if (document.cookie.indexOf(gFpc + \"=\") == -1) {\n    var wtidJs = document.createElement(\"script\");\n    wtidJs.src = \"//\" + gDomain + \"/\" + gDcsId + \"/wtid.js\";\n    document.getElementsByTagName(\"head\")[0].appendChild(wtidJs);\n  }\n\n\n\n  var detectedLocale = \u0027en-us\u0027;\n  var wtsp = \u0027_msdn_\u0027;\n  var gTrackEvents = \u00270\u0027;\n/**/" },
	{ txt: "/**/\n  var omni_guid = \"54a2ac45-741e-4970-a51a-596fc9c5b07f\";\n/**/" },
	{ url: "http://i2.msdn.microsoft.com/Combined.js?resources=0:Utilities,0:Topic,1:webtrendsscript,2:omni_rsid_MSDN,3:SearchBox;/Areas/Epx/Content/Scripts:0,/Areas/Global/Content/Webtrends/resources:1,/Areas/Global/Content/Omniture/resources/MSDN:2,/Areas/Epx/Themes/Base/Content:3\u0026amp;hashKey=E93F43E708C4E79B13014A098239D120" },
	{ url: "http://i1.services.social.microsoft.com/search/Widgets/SearchBox.jss?boxid=HeaderSearchTextBox\u0026btnid=HeaderSearchButton\u0026brand=MSDN\u0026loc=en-us\u0026Refinement=182\u0026focusOnInit=false\u0026iroot=windows%2fhardware\u0026emptyWatermark=true\u0026searchButtonTooltip=Search" },
	{ url: "http://i2.msdn.microsoft.com/Combined.js?resources=0:Header,1:Toc,1:LibraryMemberFilter,2:Toc_Fixed,3:Rating,2:CodeSnippet,2:TopicNotInScope,2:CollapsibleArea,2:VersionSelector,2:SurveyBroker;/Areas/Epx/Themes/Windows/Content:0,/Areas/Library/Content:1,/Areas/Epx/Content/Scripts:2,/Areas/Epx/Themes/Base/Content:3\u0026amp;hashKey=2738C0CC18843CA9EAD45D501FB8031F" },
	{ txt: "$(document).ready(function() {\n        try {\n            var token = $(\"#globalRequestVerification input[name=\u0027__RequestVerificationToken\u0027]\").clone();\n            $(\"#siteFeedbackForm\").append(token);\n        } catch(err) {\n            \n        }\n    });" }
]);

/*]]>*/
</script></body>

<!-- Mirrored from msdn.microsoft.com/en-us/library/windows/hardware/hh450844(v=vs.85).aspx by HTTrack Website Copier/3.x [XR&CO'2013], Mon, 17 Mar 2014 17:15:58 GMT -->
</html>