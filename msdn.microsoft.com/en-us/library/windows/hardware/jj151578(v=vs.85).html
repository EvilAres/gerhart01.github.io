<!DOCTYPE html>

<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml" lang="en">
    
<!-- Mirrored from msdn.microsoft.com/en-us/library/windows/hardware/jj151578(v=vs.85).aspx by HTTrack Website Copier/3.x [XR&CO'2013], Mon, 17 Mar 2014 17:16:05 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><link rel="canonical" href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151578(v=vs.85).aspx" />
        <title>Using activity ID GUIDs in USB ETW traces (Windows Drivers)</title>




<meta name="DCS.dcsuri" content="/en-us/library/windows/hardware/jj151578(d=default,l=en-us,v=vs.85).aspx" />

<meta name="NormalizedUrl" content="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151578(d=default,l=en-us,v=vs.85).aspx" />

<meta name="ms.normalizedurl" content="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151578(d=default,l=en-us,v=vs.85).aspx" />

<meta name="VotingContextUrl" content="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151578(d=default,l=en-us,v=vs.85).aspx" />

<meta name="MN" content="61C41DD6-9:46:26 AM" />

<meta name="Search.ShortId" content="jj151578" />

<meta name="ms.shortidmsdn" content="jj151578" />

<meta name="Ms.Locale" content="en-us" />







        
    <link rel="shortcut icon" href="http://msdn.microsoft.com/Areas/Epx/Themes/Windows/Content/Winlogo_favicon.ico" />

    <link rel="stylesheet" type="text/css" href="http://i3.msdn.microsoft.com/Combined.css?resources=0:Topic,0:CodeSnippet,0:ExpandableCollapsibleArea,1:CommunityContent,0:TopicNotInScope,0:FeedViewerBasic,0:ImageSprite,2:Header,2:sprite,1:Toc,1:LibraryMemberFilter,2:Footer,3:DetailedLinkList,3:LinkList,4:Windows;/Areas/Epx/Content/Css:0,/Areas/Library/Content:1,/Areas/Epx/Themes/Windows/Content:2,/Areas/Epx/Themes/Base/Content:3,/Areas/Library/Themes/Windows/Content:4&amp;amp;hashKey=E1AF301680B6D838738C2F52E9149624" /></head>
    <body class="library ">
        <div id="page">
            
            
  
            
    
    

    <div id="ux-header" class=" ltr">
        <div id="headerContainer">
            <div id="logoAndSearchBox">
                <div id="logo">
                    <a href="http://msdn.microsoft.com/windows/" title="Windows"><img alt="Windows" src="http://i.msdn.microsoft.com/Areas/Epx/Themes/Windows/Content/Windows_logo.png"></img></a>       
                </div>
              
        <div id="selectedTab">
            <a class="dropDownToggle" href="javascript:void(0);">Dev Center - Hardware</a>    
        </div>
    <div id="toclevel1_menu" style="display: none;">
        <ul>
                <li><a href="http://msdn.microsoft.com/windows/" title="Dev Center Home">Dev Center Home</a></li>
                <li><a href="http://msdn.microsoft.com/windows/apps/" title="Windows Store apps">Windows Store apps</a></li>
                <li><a href="http://msdn.microsoft.com/ie/" title="Internet Explorer">Internet Explorer</a></li>
                <li><a href="http://msdn.microsoft.com/windows/desktop/" title="Desktop">Desktop</a></li>
                <li><a href="http://msdn.microsoft.com/windows/hardware/" title="Hardware">Hardware</a></li>
        </ul>
        <div style="clear: both"></div>
    </div> 

                
                  

        <div class="SearchBox">   
            <form id="HeaderSearchForm" name="HeaderSearchForm" method="get" onsubmit="return Epx.Controls.SearchBox.searchBoxOnSubmit(this);">
            <input id="HeaderSearchTextBox" name="query" type="text" maxlength="200" onfocus="Epx.Controls.SearchBox.watermarkFocus(event, this.title)" onblur="Epx.Controls.SearchBox.watermarkBlur(event, this.title)" />            
            <button id="HeaderSearchButton" value="" type="submit" class="header-search-button"></button>
            </form>
         
                
                 
    
        </div>

                <div class="Clear"></div>
            </div>
            <div class="Clear"></div>
            <div class="ux-internav">
    <div class="toclevel2"> 
            <a class="normal" href="https://sysdev.microsoft.com/en-us/hardware/" title="Dashboard">Dashboard</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg507680" title="Get Started ">Get Started </a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg462970" title="Design">Design</a>
            <a class="active" href="http://msdn.microsoft.com/windows/hardware/ff960953" title="Develop">Develop</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg463010" title="Certify">Certify</a>
    </div>
    <div class="clear"></div>

            </div>
            <div id="signIn">

<a class="scarabLink" href="https://login.live.com/login.srf?wa=wsignin1.0&amp;rpsnv=12&amp;ct=1395074786&amp;rver=6.0.5276.0&amp;wp=MCLBI&amp;wlcxt=MSDN%24MSDN%24MSDN&amp;wreply=http%3a%2f%2fmsdn.microsoft.com%2fen-us%2flibrary%2fwindows%2fhardware%2fjj151578%2528v%3dvs.85%2529.aspx&amp;lc=1033&amp;id=254354&amp;mkt=en-US" title="Sign in">Sign in</a></div>

    

        </div>  
        <div id="blackBar">
    <div class="toclevel3"> 
            <a class="normal" href="http://msdn.microsoft.com/library/windows/hardware/gg454504" title="Systems">Systems</a>
            <a class="normal" href="http://msdn.microsoft.com/library/windows/hardware/gg454505" title="Devices">Devices</a>
            <a class="active" href="http://msdn.microsoft.com/library/windows/hardware/ff557573" title="Drivers">Drivers</a>
            <a class="normal" href="http://msdn.microsoft.com/library/windows/hardware/ff551063(v=vs.85).aspx" title="Debugging">Debugging</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg454513" title="Downloads">Downloads</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/dn433227.aspx" title="Samples">Samples</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/gg454517" title="Community">Community</a>
            <a class="normal" href="http://msdn.microsoft.com/windows/hardware/dn550976" title="Archives">Archives</a>
    </div>
    <div class="clear"></div>

        </div>
    </div>


        
            <div id="body">
                







    <div id="leftNav">



<div id="tocnav">
            <div class="toclevel0" data-toclevel="0">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff557557(v=vs.85).aspx" id="ff576019_VS.85_en-us" mtpsaliasid="" mtpsassetid="1ef3e216-1322-42c3-b070-94cddfb2133c_VS.85_en-us" mtpsshortid="ff557557_VS.85_en-us" title="Device and Driver Technologies">Device and Driver Technologies</a>            </div>
            <div class="toclevel0" data-toclevel="0">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff557547(v=vs.85).aspx" id="hh440424_VS.85_en-us" mtpsaliasid="" mtpsassetid="5cefa114-cec1-4058-a7a9-08e0b13fe412_VS.85_en-us" mtpsshortid="ff557547_VS.85_en-us" title="Bus and Port Drivers">Bus and Port Drivers</a>            </div>
            <div class="toclevel0" data-toclevel="0">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff538930(v=vs.85).aspx" id="dn303474_VS.85_en-us" mtpsaliasid="" mtpsassetid="45ba2638-b1b9-409d-bd23-78e75a3515be_VS.85_en-us" mtpsshortid="ff538930_VS.85_en-us" title="Universal Serial Bus (USB)">Universal Serial Bus (USB)</a>            </div>
            <div class="toclevel0" data-toclevel="0">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151576(v=vs.85).aspx" id="dn303361_VS.85_en-us" mtpsaliasid="" mtpsassetid="248BC997-03F7-41E8-95FC-2B295D696502_VS.85_en-us" mtpsshortid="jj151576_VS.85_en-us" title="Testing USB hardware, drivers, and apps in Windows">Testing USB hardware, drivers, and apps in Windows</a>            </div>
            <div class="toclevel1" data-toclevel="1">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151577(v=vs.85).aspx" id="dn448495_VS.85_en-us" mtpsaliasid="" mtpsassetid="F72C181B-1A28-4C6F-82ED-AEF517AB445D_VS.85_en-us" mtpsshortid="jj151577_VS.85_en-us" title="USB Event Tracing for Windows">USB Event Tracing for Windows</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151573(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="How to capture a USB event trace">How to capture a USB event trace</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151575(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="How to install Netmon and USB ETW Parsers">How to install Netmon and USB ETW Parsers</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151574(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="How to view a USB ETW trace in Netmon">How to view a USB ETW trace in Netmon</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151572(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="Case Study: Troubleshooting an unknown USB device by using ETW and Netmon">Case Study: Troubleshooting an unknown USB device by using ETW and Netmon</a>            </div>
            <div class="toclevel2 current" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151578(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="Using activity ID GUIDs in USB ETW traces">Using activity ID GUIDs in USB ETW traces</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a data-tochassubtree="true" href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151579(v=vs.85).aspx" id="dn434092_VS.85_en-us" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="Using Xperf with USB ETW">Using Xperf with USB ETW</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj154557(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="Debugging USB device issues by using ETW events">Debugging USB device issues by using ETW events</a>            </div>
            <div class="toclevel2" data-toclevel="2">
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj154558(v=vs.85).aspx" mtpsaliasid="" mtpsassetid="" mtpsshortid="" title="USB ETW and Power Management">USB ETW and Power Management</a>            </div>
</div>
        

        

        
        
        <div id="toc-resizable-ew" class="toc-resizable-ew"></div>
        
    </div>
<div id="content" class="content">







        

<div class="topic" xmlns="http://www.w3.org/1999/xhtml">
  <h1 class="title">Using activity ID GUIDs in USB ETW traces</h1>
  
  <div id="mainSection">
<div class="clsServerSDKContent">

</div>
<p>This topic provides information about Activity ID GUIDs, how to add those GUIDs in the event trace providers, and view them  in Netmon.</p>
<p>Drivers in the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh406256(v=vs.85).aspx">USB driver stack</a> (both 2.0 and 3.0) are ETW event trace providers. In Windows 7, while capturing event traces from the USB driver stack, you can capture traces from other providers, such as other drivers and applications. You can then read the combined log (assuming that you have created a Netmon parser for your provider's event traces).</p>
<p>Starting in Windows 8, you can associate events across providers (from applications, client driver, and the USB driver stack) by using <em>activity ID GUIDs</em>.  Events from multiple providers can be associated in Netmon when the events have the same activity ID GUID. Based on those GUIDs, Netmon can show you the set of USB events that resulted from an instrumented activity at an upper layer.</p>
<p>While viewing combined event traces from other providers in Netmon, right-click an event from an application and choose <strong>Find Conversations -&gt; NetEvent</strong> to see associated driver events. </p>
<p>This image shows you related events from an application, UMDF driver, and Ucx01000.sys (one of the drivers in the USB driver stack).These events have the same activity ID GUID. </p>
<p><img id="netmon_activity" alt="JJ151578.netmon_activity(en-us,VS.85).png" src="http://i.msdn.microsoft.com/dynimg/IC616458.png" title="JJ151578.netmon_activity(en-us,VS.85).png" xmlns="" /></p>
<p>
</p><ul>
<li><a href="#how_to_add_an_activity_id_guid_in_an_application">How to add an activity ID GUID in an application</a></li>
<li><a href="#how_to_set_the_activity_id_guid_in_a_umdf_driver">How to set the activity ID GUID in a UMDF driver</a></li>
<li><a href="#how_to_add_activity_id_guid_in_a_kernel-mode_driver">How to add activity ID GUID in a kernel-mode driver</a></li>
</ul>

<h2><a id="How_to_add_an_activity_ID_GUID_in_an_application"></a><a id="how_to_add_an_activity_id_guid_in_an_application"></a><a id="HOW_TO_ADD_AN_ACTIVITY_ID_GUID_IN_AN_APPLICATION"></a>How to add an activity ID GUID in an application</h2>
<p>An application can include activity ID GUIDs by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/aa363720(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EventActivityIdControl</strong></a>. For more information, see <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/aa363795(v=vs.85).aspx">Event Tracing Functions</a>.</p>
<p>This example code shows how an application can set an activity ID GUID and send it to the ETW provider, a UMDF driver.</p>

<div id="code-snippet-1" class="codeSnippetContainer" xmlns="">
    <div class="codeSnippetContainerTabs">
        
    </div>
    <div class="codeSnippetContainerCodeContainer">
        <div class="codeSnippetToolBar">
            <div class="codeSnippetToolBarText">
                <a name="CodeSnippetCopyLink" style="display: none;" title="Copy to clipboard." href="javascript:if (window.epx.codeSnippet)window.epx.codeSnippet.copyCode('CodeSnippetContainerCode_a3abcffa-b177-47aa-bac5-4aed18fdbff9');">Copy</a>
            </div>
        </div>
        <div id="CodeSnippetContainerCode_a3abcffa-b177-47aa-bac5-4aed18fdbff9" class="codeSnippetContainerCode" dir="ltr">
            <div style="color:Black;"><pre>

EventActivityIdControl(EVENT_ACTIVITY_CTRL_CREATE_ID, &amp;activityIdStruct.ActivityId); 
EventActivityIdControl(EVENT_ACTIVITY_CTRL_SET_ID,    &amp;activityIdStruct.ActivityId); 
                
if (!DeviceIoControl(hRead,
                     IOCTL_OSRUSBFX2_SET_ACTIVITY_ID,
                     &amp;activityIdStruct,         // Ptr to InBuffer
                     sizeof(activityIdStruct),  // Length of InBuffer
                     NULL,                      // Ptr to OutBuffer
                     0,                         // Length of OutBuffer
                     NULL,                      // BytesReturned
                     0))                        // Ptr to Overlapped structure
{         

          wprintf(L"Failed to set activity ID - error %d\n", GetLastError());
}

...

success = ReadFile(hRead, pinBuf, G_ReadLen, (PULONG) &amp;nBytesRead, NULL);

if(success == 0) 
{
          wprintf(L"ReadFile failed - error %d\n", GetLastError());

          EventWriteReadFail(0, GetLastError());

          ...


}


</pre></div>
            
        </div>
    </div>
</div>

<p>In the preceding example, an application calls  <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/aa363720(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EventActivityIdControl</strong></a> to create an activity ID (EVENT_ACTIVITY_CTRL_CREATE_ID) and then to set it (EVENT_ACTIVITY_CTRL_SET_ID) for the current thread. The application specifies that activity GUID to the ETW event provider, such as a user-mode driver, by sending a driver-defined IOCTL (described in the next section). </p>
<p>The event provider must publish an instrumentation manifest file (.MAN file). By running the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/aa385638(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">message compiler (Mc.exe)</strong></a>, a header file is generated that contains definitions for the event provider, event attributes, channels, and events.  In the example, the application calls EventWriteReadFail, which are defined in the generated header file, to write trace event messages in case of a failure. </p>
<h2><a id="How_to_set_the_activity_ID_GUID_in_a_UMDF_driver"></a><a id="how_to_set_the_activity_id_guid_in_a_umdf_driver"></a><a id="HOW_TO_SET_THE_ACTIVITY_ID_GUID_IN_A_UMDF_DRIVER"></a>How to set the activity ID GUID in a UMDF driver</h2>
<p>A user-mode driver creates and sets activity ID GUIDs by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/aa363720(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EventActivityIdControl</strong></a> and the calls are similar to the way an application calls them, as described in the previous section.  Those calls add the activity ID GUID to the current thread and that activity ID GUID is used whenever the thread logs an event. For more information, see <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh706287(v=vs.85).aspx">Using Activity Identifiers</a>.</p>
<p>This example code shows how a UMDF driver sets the activity ID GUID that was created and specified by the application through an IOCTL. </p>

<div id="code-snippet-2" class="codeSnippetContainer" xmlns="">
    <div class="codeSnippetContainerTabs">
        
    </div>
    <div class="codeSnippetContainerCodeContainer">
        <div class="codeSnippetToolBar">
            <div class="codeSnippetToolBarText">
                <a name="CodeSnippetCopyLink" style="display: none;" title="Copy to clipboard." href="javascript:if (window.epx.codeSnippet)window.epx.codeSnippet.copyCode('CodeSnippetContainerCode_9a07ec16-5afc-4c5a-b6a6-9f5c21e9dbf7');">Copy</a>
            </div>
        </div>
        <div id="CodeSnippetContainerCode_9a07ec16-5afc-4c5a-b6a6-9f5c21e9dbf7" class="codeSnippetContainerCode" dir="ltr">
            <div style="color:Black;"><pre>


VOID
STDMETHODCALLTYPE
CMyControlQueue::OnDeviceIoControl(
    _In_ IWDFIoQueue *FxQueue,
    _In_ IWDFIoRequest *FxRequest,
    _In_ ULONG ControlCode,
    _In_ SIZE_T InputBufferSizeInBytes,
    _In_ SIZE_T OutputBufferSizeInBytes
    )
/*++

Routine Description:


    DeviceIoControl dispatch routine

Aruments:
    
    FxQueue - Framework Queue instance
    FxRequest - Framework Request  instance
    ControlCode - IO Control Code
    InputBufferSizeInBytes - Lenth of input buffer
    OutputBufferSizeInBytes - Lenth of output buffer

    Always succeeds DeviceIoIoctl
Return Value:

    VOID

--*/
{
    ...

    switch (ControlCode)
    {

        ....

        case IOCTL_OSRUSBFX2_SET_ACTIVITY_ID:
        {
            if (InputBufferSizeInBytes &lt; sizeof(UMDF_ACTIVITY_ID))
            {
                hr = HRESULT_FROM_WIN32(ERROR_INSUFFICIENT_BUFFER);
            }
            else
            {
                FxRequest-&gt;GetInputMemory(&amp;memory );
            }

            if (SUCCEEDED(hr)) 
            {
                buffer = memory-&gt;GetDataBuffer(&amp;bigBufferCb);
                memory-&gt;Release();

                m_Device-&gt;SetActivityId(&amp;((PUMDF_ACTIVITY_ID)buffer)-&gt;ActivityId);
                hr = S_OK;
            }

            break;
        }
    } 
}

VOID
 SetActivityId(
        LPCGUID ActivityId
        )
    {
        CopyMemory(&amp;m_ActivityId, ActivityId, sizeof(m_ActivityId));
    }



void
CMyReadWriteQueue::ForwardFormattedRequest(
    _In_ IWDFIoRequest*                         pRequest,
    _In_ IWDFIoTarget*                          pIoTarget
    )
{
...
    pRequest-&gt;SetCompletionCallback(
        pCompletionCallback,
        NULL
        );

...
    hrSend = pRequest-&gt;Send(pIoTarget,
                            0,  //flags
                            0); //timeout

...
    if (FAILED(hrSend))
    {
        contextHr = pRequest-&gt;RetrieveContext((void**)&amp;pRequestContext);

        if (SUCCEEDED(contextHr)) {

            EventActivityIdControl(EVENT_ACTIVITY_CTRL_SET_ID, &amp;pRequestContext-&gt;ActivityId);

            if (pRequestContext-&gt;RequestType == RequestTypeRead)
            {
                EventWriteReadFail(m_Device, hrSend);
            }

            delete pRequestContext;
        }

        pRequest-&gt;CompleteWithInformation(hrSend, 0);
    }

    return;
}




</pre></div>
            
        </div>
    </div>
</div>

<p>Let's see how the activity ID GUID that was created by the application gets associated with a <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff560027(v=vs.85).aspx">User-Mode Driver Framework</a> (UMDF) client driver. When the driver receives the IOCTL request from the application, it copies the GUID in a private member. At some point, the application calls <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/aa365467(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">ReadFile</strong></a> to perform a read operation. The framework creates a request and invokes the driver's handler, ForwardFormattedRequest. In the handler, the driver sets the previously stored activity ID GUID on the thread by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/aa363720(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EventActivityIdControl</strong></a> and EventWriteReadFail to trace event messages. </p><p class="note"><strong>Note</strong>  The UMDF driver must also include the header file that is generated through the instrumentation manifest file. The header file defines macros such as EventWriteReadFail that write trace messages.</p>

<h2><a id="How_to_add_activity_ID_GUID_in_a_kernel-mode_driver"></a><a id="how_to_add_activity_id_guid_in_a_kernel-mode_driver"></a><a id="HOW_TO_ADD_ACTIVITY_ID_GUID_IN_A_KERNEL-MODE_DRIVER"></a>How to add activity ID GUID in a kernel-mode driver</h2>
<p>In kernel mode, a driver can trace messages on the thread that originates in user mode or a thread that the driver creates. In both those cases, the driver requires the activity ID GUID of the thread.</p>
<p>To trace messages, the driver must obtain the registration handle as an event provider (see <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff545603(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EtwRegister</strong></a>) and  then call <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff545627(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EtwWrite</strong></a> by specifying the GUID and the event message. For more information, see <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff541236(v=vs.85).aspx">Adding Event Tracing to Kernel-Mode Drivers</a>.</p>
<p>If your  kernel- mode driver handles a request that was created by an application or a user-mode driver, the kernel-mode driver does not create and set an activity ID GUID. Instead, the I/O manager handles most of the activity ID propagation. When a user-mode thread initiates a request, the I/O manager creates an IRP for the request and automatically copies the current thread's activity ID GUID into the new IRP. If the kernel-mode driver wants to trace events on that thread, it must get the GUID by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh439309(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">IoGetActivityIdIrp</strong></a>, and then call <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff545627(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EtwWrite</strong></a>. </p>
<p>If your kernel-mode driver creates an IRP with  an activity ID GUID, the driver can call <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff545578(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EtwActivityIdControl</strong></a> with EVENT_ACTIVITY_CTRL_CREATE_SET_ID to generate a new GUID. The driver can then associate the new GUID with the IRP by calling <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/hh439382(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">IoSetActivityIdIrp</strong></a>and then call <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff545627(v=vs.85).aspx"><strong xmlns="http://www.w3.org/1999/xhtml">EtwWrite</strong></a>.</p>
<p>The activity ID GUID is passed along with the IRP to the next lower drivers. The lower drivers can add their trace messages to the thread.</p>
<h2><a id="related_topics"></a>Related topics</h2>
<dl>
<dt>
<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj151577(v=vs.85).aspx">USB Event Tracing for Windows</a>
</dt>
</dl>
<p> </p>
<p> </p>
<p><a href="mailto:wsddocfb@microsoft.com?subject=Documentation%20feedback [usbcon\buses]:%20Using activity ID GUIDs in USB ETW traces%20 RELEASE:%20(2/20/2014)&amp;body=%0A%0APRIVACY STATEMENT%0A%0AWe use your feedback to improve the documentation. We don't use your email address for any other purpose, and we'll remove your email address from our system after the issue that you're reporting is fixed. While we're working to fix this issue, we might send you an email message to ask for more info. Later, we might also send you an email message to let you know that we've addressed your feedback.%0A%0AFor more info about Microsoft's privacy policy, see http://privacy.microsoft.com/en-us/default.aspx." title="Send comments about this topic to Microsoft">Send comments about this topic to Microsoft</a></p>
</div>
</div>

    




<div class="libraryMemberFilter">
    <div class="filterContainer">
        <span>Show:</span>
        <label>
            <input type="checkbox" class="libraryFilterInherited" checked="checked" value="Inherit" />Inherited
        </label>
        <label>
            <input type="checkbox" class="libraryFilterProtected" checked="checked" value="Protected" />Protected
        </label>
    </div>
</div>
    
<input type="hidden" id="libraryMemberFilterEmptyWarning" value="There are no members available with your current filter settings." />


 
</div>




            </div>
            <div class="clear"></div>
        
            
    
<input name="__RequestVerificationToken" type="hidden" value="YOPwhZ0vBy3aVCG264MPszgJ2qamVexWuZqhb5zKFDjr6q_84eL85pzLJWNupBdNuRy0JUxlfF9TyK4F1_ZsbHOdjZAUOO3BOQzSOAtTiNpo1fxB7iPrM2lU-1mNesGerj5jZQ2" />
<input id="ratingSubmitUrl" type="hidden" value="http://msdn.microsoft.com/en-us/library/feedback/add/jj151578(v=vs.85).aspx" />
<input id="isTopicRated" type="hidden" value="false" />




    


    <div id="ux-footer" class=" ltr">
        
            <div id="footerSock">
                <div id="footerSockInner">
                    <a name="feedback"></a>
                    <div data-fragmentName="Survey" id="Fragment_Survey" xmlns="http://www.w3.org/1999/xhtml">
  <div class="DetailedLink">
    
    <div class="Content"></div>
  </div>
</div>
<div class="rating">
    <div id="ratingSection1">
        <div class="title">
            Was this page helpful?
        </div>
        <div class="description">
            Your feedback about this content is important.<br />Let us know what you think.
        </div>
        <div class="buttons">
            <button id="ratingYes">Yes</button>
            <button id="ratingNo">No</button>
        </div>
        <input id="ratingValue" type="hidden" value="" />
    </div>
    <div id="ratingSection2">
        <div class="title">
            Additional feedback?
        </div>
        <textarea id="ratingText" rows="6" cols=""></textarea>
        <div class="buttons">
            <button id="ratingSubmit">Submit</button>
            <button id="ratingSkipThis">Skip this</button>
        </div>
    </div>
    <div id="ratingSection3">
        <div class="title">
            Thank you!
        </div>
        <div class="description">
            We appreciate your feedback.
        </div>
    </div>
    
    
    <div id="contentFeedbackQAContainer" style="display: none;"></div>
</div>


                    <div data-fragmentName="SockLinks" id="Fragment_SockLinks" xmlns="http://www.w3.org/1999/xhtml">
  
  <div class="LinkList">
    <div class="Links">
      <ul class="LinkColumn" style="width: 100%">
        <li>
          <a href="http://go.microsoft.com/fwlink/p/?LinkId=317805" id="SockLinks_727_11" xmlns="http://www.w3.org/1999/xhtml">Find us on Facebook</a>
        </li>
        <li>
          <a href="http://go.microsoft.com/fwlink/p/?LinkId=317806" id="SockLinks_727_12" xmlns="http://www.w3.org/1999/xhtml">Follow us on Twitter</a>
        </li>
        <li>
          <a href="http://go.microsoft.com/fwlink/p/?linkid=285656" id="SockLinks_727_40" xmlns="http://www.w3.org/1999/xhtml">Read the hardware blog</a>
        </li>
      </ul>
    </div>
  </div>
</div>
                    <div class="clear"></div>
                </div>
            </div>
        <div id="footerContainer">
            <div id="fourColumnFooter">
                <div data-fragmentName="Column1" id="Fragment_Column1" xmlns="http://www.w3.org/1999/xhtml">
  <div class="ListOfLinkLists">
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Centers</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://msdn.microsoft.com/windows" id="Column1_727_13" xmlns="http://www.w3.org/1999/xhtml">Dev Center Home</a>
          </li>
          <li>
            <a href="http://msdn.microsoft.com/windows/apps" id="Column1_727_14" xmlns="http://www.w3.org/1999/xhtml">Windows Store apps</a>
          </li>
          <li>
            <a href="http://msdn.microsoft.com/ie" id="Column1_727_15" xmlns="http://www.w3.org/1999/xhtml">Internet Explorer</a>
          </li>
          <li>
            <a href="http://msdn.microsoft.com/windows/desktop" id="Column1_727_16" xmlns="http://www.w3.org/1999/xhtml">Desktop</a>
          </li>
          <li>
            <a href="http://msdn.microsoft.com/windows/hardware" id="Column1_727_17" xmlns="http://www.w3.org/1999/xhtml">Hardware</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>              
                <div data-fragmentName="Column2" id="Fragment_Column2" xmlns="http://www.w3.org/1999/xhtml">
  <div class="ListOfLinkLists">
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Related developer sites</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285634" id="Column2_727_18" xmlns="http://www.w3.org/1999/xhtml">Microsoft Connect</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285635" id="Column2_727_19" xmlns="http://www.w3.org/1999/xhtml">OSR Online</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=282089" id="Column2_727_42" xmlns="http://www.w3.org/1999/xhtml">Visual Studio</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=280293" id="Column2_727_20" xmlns="http://www.w3.org/1999/xhtml">Windows Phone</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=282087" id="Column2_727_43" xmlns="http://www.w3.org/1999/xhtml">Windows Server</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Other Windows sites</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285636" id="Column2_727_21" xmlns="http://www.w3.org/1999/xhtml">Enterprise</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285637" id="Column2_727_22" xmlns="http://www.w3.org/1999/xhtml">Small business</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285638" id="Column2_727_23" xmlns="http://www.w3.org/1999/xhtml">Students</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285639" id="Column2_727_24" xmlns="http://www.w3.org/1999/xhtml">Home users</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>              
                <div data-fragmentName="Column3" id="Fragment_Column3" xmlns="http://www.w3.org/1999/xhtml">
  <div class="ListOfLinkLists">
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Downloads</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285645" id="Column3_727_25" xmlns="http://www.w3.org/1999/xhtml">Windows Driver Kit</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285646" id="Column3_727_26" xmlns="http://www.w3.org/1999/xhtml">Windows Assessment and Deployment Kit</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285647" id="Column3_727_27" xmlns="http://www.w3.org/1999/xhtml">Windows Hardware Certification Kit</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?LinkID=316548" id="Column3_727_29" xmlns="http://www.w3.org/1999/xhtml">Visual Studio Professional 2013</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285649" id="Column3_727_30" xmlns="http://www.w3.org/1999/xhtml">More downloads</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Support</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285664" id="Column3_727_44" xmlns="http://www.w3.org/1999/xhtml">Forums</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285663" id="Column3_727_45" xmlns="http://www.w3.org/1999/xhtml">More support options</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>              
                <div data-fragmentName="Column4" id="Fragment_Column4" xmlns="http://www.w3.org/1999/xhtml">
  <div class="ListOfLinkLists">
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Essentials</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285650" id="Column4_727_46" xmlns="http://www.w3.org/1999/xhtml">Recently published</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285651" id="Column4_727_47" xmlns="http://www.w3.org/1999/xhtml">Debugging</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=328186" id="Column4_727_48" xmlns="http://www.w3.org/1999/xhtml">Samples</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285653" id="Column4_727_49" xmlns="http://www.w3.org/1999/xhtml">Hardware dashboard</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=317804" id="Column4_727_50" xmlns="http://www.w3.org/1999/xhtml">Partner with Microsoft</a>
          </li>
        </ul>
      </div>
    </div>
    
    <div class="LinkList" xmlns="http://www.w3.org/1999/xhtml">
      <div class="LinkListTitle">Stay connected</div>
      <div class="Links">
        <ul class="LinkColumn" style="width: 100%">
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=285658" id="Column4_727_36" xmlns="http://www.w3.org/1999/xhtml">Microsoft events</a>
          </li>
          <li>
            <a href="http://go.microsoft.com/fwlink/p/?linkid=313299" id="Column4_727_37" xmlns="http://www.w3.org/1999/xhtml">Windows App Builder Blog</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>              
            </div>

            <div id="baseFooterLogos">
                <span class="microsoftlogo" title="Microsoft"></span>
                <a href="http://msdn.microsoft.com/en-us" class="msdnlogo" title="MSDN"></a>
            </div>
        
            <div id="baseFooter">
                <div id="FooterCopyright">© 2014 Microsoft</div>
                <div data-fragmentName="BaseFooterContent" id="Fragment_BaseFooterContent" xmlns="http://www.w3.org/1999/xhtml">
  <div xmlns="http://www.w3.org/1999/xhtml">
    <div xmlns:mtps="http://msdn2.microsoft.com/mtps">
      <div data-fragmentName="BaseFooter" id="Fragment_BaseFooter">
        
        <div class="LinkList">
          <div class="Links">
            <ul class="LinkColumn horizontal">
              <li>
                <a href="http://msdn.microsoft.com/windows/apps/cc300389" id="BaseFooter_35351_1" xmlns="http://www.w3.org/1999/xhtml">Terms of Use</a>
              </li>
              <li>
                <a href="http://www.microsoft.com/library/toolbar/3.0/trademarks/en-us.mspx" id="BaseFooter_35351_2" xmlns="http://www.w3.org/1999/xhtml">Trademarks</a>
              </li>
              <li>
                <a href="http://www.microsoft.com/info/privacy.mspx" id="BaseFooter_35351_3" xmlns="http://www.w3.org/1999/xhtml">Privacy and Cookies</a>
              </li>
              <li>
                <a href="http://msdn.microsoft.com/en-us/windows/dn554289" id="BaseFooter_730_5" xmlns="http://www.w3.org/1999/xhtml">Site map</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div data-fragmentName="HelloText" id="Fragment_HelloText">Hello from Seattle.
</div>
    </div>
  </div>
</div>  
                    <form class="selectLocale" id="selectLocaleForm" action="http://msdn.microsoft.com/en-us/windows/hardware/SelectLocale">
        <input type="hidden" name="fromPage" value="http%3a%2f%2fmsdn.microsoft.com%2fen-us%2flibrary%2fwindows%2fhardware%2fjj151578(v%3dvs.85).aspx" />
        <a href="#" onclick="$('#selectLocaleForm').submit();return false;" title="Change your language">United States (English)</a>
    </form>    


                <div class="clear"></div>
            </div>
        </div>
    </div> 


            <div class="footerPrintView">
                <div class="footerCopyrightPrintView">© 2014 Microsoft. All rights reserved.</div>
            </div>

            
            
    


        
            <input id="MtpsDevice" type="hidden" value="Default" />


<![CDATA[ Third party scripts and code linked to or referenced from this website are licensed to you by the parties that own such code, not by Microsoft.  See ASP.NET Ajax CDN Terms of Use – http://www.asp.net/ajaxlibrary/CDN.ashx. ]]>
        
            
            
            
            
            
        





<noscript><div><img alt="DCSIMG" id="Img1" width="1" height="1" src="http://m.webtrends.com/dcsmgru7m99k7mqmgrhudo0k8_8c6m/njs.gif?dcsuri=/nojavascript&amp;WT.js=No" /></div></noscript>









<noscript>
  <a href="http://www.omniture.com/" title="Web Analytics">
    <img src="http://msstonojsmsdn.112.2o7.net/b/ss/msstonojsmsdn/1/H.20.2--NS/0" height="1" width="1" border="0" alt="" />
  </a>
</noscript>




<div id="globalRequestVerification">
    <input name="__RequestVerificationToken" type="hidden" value="N4yhm9T9JfDcrk3Gu9x5ILHyfWaeTGExxFIoWXo31dNBE6FobZuLynbMMI2a2g6IbcpBBC0vrevkWO4cWSdZpEqyXl5VjesqGSxrSYTjHdLKDrJHh4gWS9LwEjWMMxhWPnh0eg2" />
</div>


        </div>
    <script type="text/javascript" class="mtps-injected">
/*<![CDATA[*/
(function(window,document){"use strict";function preload(scripts){for(var result=[],script,e,i=0;i<scripts.length;i++)script=scripts[i],script.hasOwnProperty("url")&&(e=document.createElement("script"),e.src=script.url,script.throwaway=e),result.push(script);return result}function inject(scripts,index){var script,elem;if(index>=scripts.length){delete mtps.injectScripts;return}script=scripts[index];elem=document.createElement("script");elem.className="mtps-injected";elem.async=!1;var isLoaded=!1,timeoutId=0,injectNextFnName="",injectNext=elem.onerror=function(){isLoaded||(isLoaded=!0,inject(scripts,index+1),window.clearTimeout(timeoutId),elem.onload=elem.onerror=elem.onreadystatechange=null,injectNextFnName&&delete mtps[injectNextFnName],elem.removeEventListener&&elem.removeEventListener("load",injectNext,!1))};elem.addEventListener?elem.addEventListener("load",injectNext,!1):elem.readyState==="uninitialized"?elem.onreadystatechange=function(){(this.readyState==="loaded"||this.readyState==="complete")&&injectNext()}:elem.onload=injectNext;script.hasOwnProperty("url")?(timeoutId=window.setTimeout(injectNext,12e4),elem.src=script.url):(injectNextFnName="_injectNextScript_"+index,mtps[injectNextFnName]=injectNext,timeoutId=window.setTimeout(injectNext,2e3),elem.text="try {\n"+script.txt+"\n} finally { MTPS."+injectNextFnName+" && MTPS."+injectNextFnName+"(); }");parent.appendChild(elem)}var mtps=window.MTPS||(window.MTPS={}),parent=document.getElementsByTagName("head")[0];mtps.injectScripts=function(scripts){inject(preload(scripts),0)}})(window,document);
MTPS.injectScripts([
	{ txt: "/**/\r\n(window.MTPS || (window.MTPS = {})).cdnDomains || (window.MTPS.cdnDomains = { \r\n\t\"image\": \"http://i.msdn.microsoft.com\", \r\n\t\"js\": \"http://i2.msdn.microsoft.com\", \r\n\t\"css\": \"http://i3.msdn.microsoft.com\"\r\n});\r\n/**/" },
	{ url: "http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.2.min.js" },
	{ txt: "//\n  var literalNormalizedUrl = \u0027/en-us/library/windows/hardware/jj151578(d=default,l=en-us,v=vs.85).aspx\u0027;\n  var wt_nvr_ru = \u0027WT_NVR_RU\u0027;\n  var wt_fpcdom = \u0027.microsoft.com\u0027;\n  var wt_domlist = \u0027msdn.microsoft.com\u0027;\n  var wt_pathlist = \u0027\u0027;\n  var wt_paramlist = \u0027DCSext.mtps_devcenter\u0027;\n  var wt_siteid = \u0027MSDN\u0027;\n  var gDomain = \u0027m.webtrends.com\u0027;\n  var gDcsId = \u0027dcsmgru7m99k7mqmgrhudo0k8_8c6m\u0027;\n  var gFpc = \u0027WT_FPC\u0027;\n\n\n\n  if (document.cookie.indexOf(gFpc + \"=\") == -1) {\n    var wtidJs = document.createElement(\"script\");\n    wtidJs.src = \"//\" + gDomain + \"/\" + gDcsId + \"/wtid.js\";\n    document.getElementsByTagName(\"head\")[0].appendChild(wtidJs);\n  }\n\n\n\n  var detectedLocale = \u0027en-us\u0027;\n  var wtsp = \u0027_msdn_\u0027;\n  var gTrackEvents = \u00270\u0027;\n/**/" },
	{ txt: "/**/\n  var omni_guid = \"96595d3a-1b72-4bb7-a347-731d0a47f8b2\";\n/**/" },
	{ url: "http://i2.msdn.microsoft.com/Combined.js?resources=0:Utilities,0:Topic,1:webtrendsscript,2:omni_rsid_MSDN,3:SearchBox;/Areas/Epx/Content/Scripts:0,/Areas/Global/Content/Webtrends/resources:1,/Areas/Global/Content/Omniture/resources/MSDN:2,/Areas/Epx/Themes/Base/Content:3\u0026amp;hashKey=E93F43E708C4E79B13014A098239D120" },
	{ url: "http://i3.services.social.microsoft.com/search/Widgets/SearchBox.jss?boxid=HeaderSearchTextBox\u0026btnid=HeaderSearchButton\u0026brand=MSDN\u0026loc=en-us\u0026Refinement=182\u0026focusOnInit=false\u0026iroot=windows%2fhardware\u0026emptyWatermark=true\u0026searchButtonTooltip=Search" },
	{ url: "http://i2.msdn.microsoft.com/Combined.js?resources=0:Header,1:Toc,1:LibraryMemberFilter,2:Toc_Fixed,3:Rating,2:CodeSnippet,2:TopicNotInScope,2:CollapsibleArea,2:VersionSelector,2:SurveyBroker;/Areas/Epx/Themes/Windows/Content:0,/Areas/Library/Content:1,/Areas/Epx/Content/Scripts:2,/Areas/Epx/Themes/Base/Content:3\u0026amp;hashKey=2738C0CC18843CA9EAD45D501FB8031F" },
	{ txt: "$(document).ready(function() {\n        try {\n            var token = $(\"#globalRequestVerification input[name=\u0027__RequestVerificationToken\u0027]\").clone();\n            $(\"#siteFeedbackForm\").append(token);\n        } catch(err) {\n            \n        }\n    });" }
]);

/*]]>*/
</script></body>

<!-- Mirrored from msdn.microsoft.com/en-us/library/windows/hardware/jj151578(v=vs.85).aspx by HTTrack Website Copier/3.x [XR&CO'2013], Mon, 17 Mar 2014 17:16:05 GMT -->
</html>